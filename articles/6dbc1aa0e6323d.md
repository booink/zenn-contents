---
title: "PyO3ãŒç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’çœºã‚ã¦ã¿ã‚‹"
emoji: "ğŸ“‘"
type: "tech"
topics: ["Python", "Rust"]
published: true
---
## 2021/03/09 è¿½è¨˜

https://github.com/PyO3/pyo3/blob/master/guide/src/class.md#implementation-details
ã“ã“ã«ã»ã¨ã‚“ã©æ›¸ã„ã¦ã‚ã‚‹ã£ã½ã„

## æ¤œè¨¼ç’°å¢ƒ

* Linux 5.4.0-66-generic #74~18.04.2-Ubuntu SMP Fri Feb 5 11:17:31 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
	* ZorinOS coreç‰ˆ 15.3
* Docker version 20.10.5, build 55c4c88
* docker-compose version 1.27.4, build 40524192
* rust:1.50-slim-buster
	* rustc 1.50.0 (cb75ad5db 2021-02-10)
	* cargo 1.50.0 (f04e7fab7 2021-02-04)

## ãƒªãƒã‚¸ãƒˆãƒª

https://github.com/booink/pyo3-test


## Cargo.toml

```toml
[package]
name = "pyo3_test"
version = "0.1.0"
authors = ["booink <booink.work@gmail.com>"]
edition = "2018"

[lib]
name = "pyo3_test"
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.13.1", extension-module = ["extension-module"], default = ["extension-module"] }
```

## src/lib.rs

PyO3 ã§æ§‹é€ ä½“ã‚’å¤–å‡ºã—ã™ã‚‹ã ã‘ã®å˜ç´”ãªã‚³ãƒ¼ãƒ‰ã«ç•™ã‚ã¦ãŠãã¾ã™ã€‚

```rust
use pyo3::prelude::*;

#[pyclass]
struct Hello {
    #[pyo3(get)]
    world: String,
}

#[pymodule]
fn pyo3_test(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_class::<Hello>()?;

    Ok(())
}
```

## cargo expand

nightly ç‰ˆã˜ã‚ƒãªã„ã¨ `error: the option `Z` is only accepted on the nightly compiler` ã¨æ€’ã‚‰ã‚Œã‚‹ã®ã§ã€nightly ç‰ˆã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã‹ã‚‰ expand ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
rustup toolchain install nightly
cargo expand > expand/pyo3_test.rs
```

## expandã—ãŸã‚³ãƒ¼ãƒ‰

https://github.com/booink/pyo3-test/blob/9aa84c349361484ca253d04dce715682a09440de/expand/pyo3_test.rs

(åãå‡ºã—ãŸã¾ã¾ã®ã‚½ãƒ¼ã‚¹ã ã¨è‹¥å¹²è¦‹ã¥ã‚‰ã‹ã£ãŸã®ã§ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’å¤‰æ›´ã—ã¦ã¾ã™)

### line 1 - 5

```rust
#![feature(prelude_import)]
#[prelude_import]
use std::prelude::v1::*;
#[macro_use]
extern crate std;
```

æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‘¼ã³å‡ºã—ã€‚
ç©ºã£ã½ã® src/lib.rs ã«å¯¾ã—ã¦ cargo expand ã™ã‚‹ã¨ã€â†‘ã“ã‚Œã ã‘ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚

### line 6 - 10

```rust
use pyo3::prelude::*;

struct Hello {
    world: String,
}
```

å®šç¾©ã—ãŸæ§‹é€ ä½“ãŒãã®ã¾ã¾å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã€‚

### line 11 - 28

```rust
unsafe impl pyo3::type_object::PyTypeInfo for Hello {
    type Type = Hello;
    type BaseType = pyo3::PyAny;
    type Layout = pyo3::PyCell<Self>;
    type BaseLayout = pyo3::pycell::PyCellBase<pyo3::PyAny>;
    type Initializer = pyo3::pyclass_init::PyClassInitializer<Self>;
    type AsRefTarget = pyo3::PyCell<Self>;
    const NAME: &'static str = "Hello";
    const MODULE: Option<&'static str> = None;
    const DESCRIPTION: &'static str = "\u{0}";
    const FLAGS: usize = 0 | 0;
    #[inline]
    fn type_object_raw(py: pyo3::Python) -> *mut pyo3::ffi::PyTypeObject {
        use pyo3::type_object::LazyStaticType;
        static TYPE_OBJECT: LazyStaticType = LazyStaticType::new();
        TYPE_OBJECT.get_or_init::<Self>(py)
    }
}
```

`PyTypeInfo` traitã®å®Ÿè£…ã€‚
https://docs.rs/pyo3/0.2.5/pyo3/typeob/trait.PyTypeInfo.html

FFIã§Pythonã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®å‹æƒ…å ±ã ã‚ã†ã‹ã€‚

### line 29 - 33

```rust
impl pyo3::PyClass for Hello {
    type Dict = pyo3::pyclass_slots::PyClassDummySlot;
    type WeakRef = pyo3::pyclass_slots::PyClassDummySlot;
    type BaseNativeType = pyo3::PyAny;
}
```

`PyClass` traitã®å®Ÿè£…ã€‚
https://pyo3.rs/master/doc/pyo3/pyclass/trait.PyClass.html

> If `PyClass` is implemented for `T`, then we can use `T` in the Python world, via `PyCell`.

`PyCell` ã‚’çµŒç”±ã—ã¦ Python å´ã«ä»»æ„ã®æ§‹é€ ä½“ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€çš„ãªã“ã¨ã€‚
`PyClassDummySlot` å‹ãŒæ°—ã«ãªã‚‹ãŒã€å¾Œå›ã—ã€‚

### line 34 - 47

```rust
impl <'a> pyo3::derive_utils::ExtractExt<'a> for &'a Hello {
    type Target = pyo3::PyRef<'a, Hello>;
}
impl <'a> pyo3::derive_utils::ExtractExt<'a> for &'a mut Hello {
    type Target = pyo3::PyRefMut<'a, Hello>;
}
impl pyo3::pyclass::PyClassSend for Hello {
    type ThreadChecker = pyo3::pyclass::ThreadCheckerStub<Hello>;
}
impl pyo3::IntoPy<pyo3::PyObject> for Hello {
    fn into_py(self, py: pyo3::Python) -> pyo3::PyObject {
        pyo3::IntoPy::into_py(pyo3::Py::new(py, self).unwrap(), py)
    }
}
```

#### ExtractExt

https://github.com/PyO3/pyo3/blob/1dcda8809d8de42670a55d39b7ccbe2ef412dead/src/derive_utils.rs#L337-L348

> Utility trait to enable &PyClass as a pymethod/function argument

`#[pyclass]` ã§å®šç¾©ã—ãŸæ§‹é€ ä½“ã®å®Ÿè£…ã§ pymethods ãªã©ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒˆãƒ¬ã‚¤ãƒˆã€ã¿ãŸã„ãªæ„Ÿã˜ï¼Ÿ

#### PyClassSend

çœ ã„ã€‚ä»Šæ—¥ã¯ã“ã“ã¾ã§ã€‚
å¾Œæ—¥è¿½è¨˜ã—ã¾ã™ã€‚
